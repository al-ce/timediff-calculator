<!DOCTYPE html>
<html>
<head>
  <!-- % CSS % -->

  <style type="text/css">
      :root {
        --bg: #fdf5e6;
        --peacock: rgb(34, 78, 90);
        --blue: rgb(43, 93, 148);
        --arcticblue: rgb(160, 207, 211);
        --mistygray: rgb(220, 221, 222);
        --tigerorange: rgb(245, 106, 48);
        --white: #fff;
        --black: #000;
        --steelgray: rgb(147, 149, 152);
        --adjustColor: var(--tigerorange);
        --shadows: rgba(0, 0, 0, .2) 0 3px 5px -1px, rgba(0, 0, 0, .14) 0 6px 10px 0, rgba(0, 0, 0, .12) 0 1px 18px 0;
      }

      html {
        zoom: 150%;
      }

      body {
        background-color: var(--bg);
        text-align: center;
      }

      button {
        background-color: var(--white);
        border-radius: 24px;
        border-style: none;
        box-shadow: var(--shadows);
        color: var(--steelgray);
        cursor: pointer;
        padding: 0px 8px;
        position: relative;
      }

      button:hover {
        background: #F6F9FE;
        color: var(--peacock);
        max-height: 24px;
      }

      input {
        border-radius: 4px;
      }

      table {
        box-shadow: var(--shadows);
        table-layout: fixed;
        width: 100%;
        max-width: 360px;
        border-collapse: separate;
        border-spacing: 0;
        border: 2px solid black;
        border-radius: 4px;
        border-top-right-radius: 0px;
        border-top-left-radius: 0px;
      }

      caption,
      thead,
      tfoot {
        background-color: var(--peacock);
        color: var(--white);
        font-weight: bold;
      }

      caption {
        border: 2px solid black;
        border-bottom: 0px;
        border-radius: 4px;
        border-bottom-right-radius: 0px;
        border-bottom-left-radius: 0px;
        padding: 8px;
      }

      tfoot {
        style border-top: 3px dotted rgb(160 160 160);
      }

      /* Delete button header cell */
      thead th:nth-child(1) {
        width: 8%;
      }

      /* Subtotal header cell */
      thead th:nth-child(4) {
        width: 22%;
      }

      th,
      td {
        padding: 8px;
      }

      tbody {
        border: 1px solid black;
      }

      tbody tr:nth-child(even) {
        background-color: var(--mistygray);
      }

      ul li {
        padding: 2px;
      }

      .adjusted {
        font-style: italic;
      }

      .alerts {
        background-color: var(--mistygray);
      }

      .content {
        max-width: 900px;
        padding-top: 20px;
        display: flex;
        flex-flow: row wrap;
        column-gap: 40px;
        align-items: flex-start;
        justify-content: space-evenly;
      }

      .calculator {}

      .firstCol {
        width: 275px;
      }

      .options,
      .usage {
        text-align: left;
        border: 2px solid black;
        box-shadow: var(--shadows);
      }

      .optionsHeader,
      .usageHeader {
        padding: 4px;
        text-align: center;
        background-color: var(--peacock);
        color: var(--white);
        font-weight: bold;
      }

      .optionsContent,
      .usageContent {
        margin-right: 8px;
      }

      .optionsCheckbox {
        margin-right: 8px;
        margin-bottom: 4px;
      }

      .optionsCheckbox:hover input {
        cursor: pointer;
      }

      .usageContent {
        font-size: smaller;
      }

      .varInputsContainer {
        display: flex;
        flex-flow: column wrap;
        align-items: flex-end;
        padding-right: 8px;
        padding-bottom: 8px;
      }

      .breaksVar {
        font-weight: bolder;
        color: var(--tigerorange);
      }

      .varInput {
        width: 50px;
      }

      .key {
        background-color: var(--blue);
        color: var(--white);
        width: 8px;
        height: 4px;
        border: 1px solid var(--black);
        border-radius: 6px;
        padding: 2px;

      }
  </style>
  <title></title>
</head>
<body>
  <!-- % SCRIPT % -->
  <script>
      // %% Globals %%
      const title = "Time Diff Calculator";
      const defaultSubtotal = "---";
      const defaultTime = "09:00";
      const defaultDate = "2000-01-01";

      /**
       * @typedef {Object} State
       * @property {boolean} adjustPerHour - Adjust calculations by x per y hours
       */

      /** @type {State} */
      const state = {
        adjustPerHour: false,
      };

      /**
       * @typedef {Object} TimeRow
       * @property {number} startTime - Start time in milliseconds
       * @property {number} endTime - End time in milliseconds
       * @property {number} diff - Difference between start and end times
       */

      /**
       * Creates a new TimeRow Object
       * @return {TimeRow}
       */
      function createTimeRow() {
        return {
          startTime: new Date(`${defaultDate}T${defaultTime}Z`),
          endTime: new Date(`${defaultDate}T${defaultTime}Z`),
          diff: 0,
        };
      }

      /**
       * @typedef {Map<number, TimeRow>} TimeRows
       * @description
       * A Map of numerical indices as keys and TimeRow Objects as values
       */

      /** @type {TimeRows} */
      let timeRows = new Map();

      // %% Helpers %%

      /**
       * Shorthand for getting an HTMLElement by id
       * @param {string} id Element id
       * @returns {HTMLElement}
       **/
      function idGet(id) {
        return document.getElementById(id);
      }

      /**
       * Pad or truncate a number to two decimal places
       * @param {number} num A Number object
       * @return {number}
       **/
      function twoPad(num) {
        return num.toFixed(2);
      }

      /**
       * Transform a Date object into a number truncated to two decimal places
       * @param {Date} dateObj A Date object
       * @return {number}
       **/
      function dateToFraction(dateObj) {
        const mm = Math.floor(dateObj / 1000 / 60) % 60;
        const hh = Math.floor(dateObj / 1000 / 60 / 60);
        const fractionalTime = hh + mm / 60;
        return Math.round(fractionalTime * 100) / 100;
      }

      /**
       * Focus either the previous input cell in the timeRows Map given a start
       * index, or the first if one is not specified.
       * @param {start?} number An optional start index
       * @return {number}
       **/
      function focusPrevInput(start) {
        start = start == null ? keys.length : start;
        let startInputElement;
        for (; start > 0; start--) {
          startInputElement = idGet(`startInput${start}`);
          if (startInputElement !== null) {
            break;
          }
        }
        // FIX: does not focus first row after first row is deleted
        startInputElement.focus();
      }

      /**
       * Uncheck all HTML input elements.
       **/
      function uncheckInputElements() {
        const inputs = document.getElementsByTagName("input");
        for (let i = 0; i < inputs.length; i++) {
          inputs[i].checked = false;
        }
      }

      // %% Main functionality %%

      /**
       * Update the time diff (subtotal) of a timeRow.
       * @param {"start" | "end"} name Name of input element
       * @param {number} idx Index to identify the timeRow
       **/
      function updateTimeDiff(name, idx) {
        const timeRow = timeRows.get(idx);
        const inputElement = idGet(`${name}Input${idx}`);
        const subtotalCell = idGet(`subtotalCell${idx}`);
        timeRow[`${name}Time`] = new Date(
          `${defaultDate}T${inputElement.value}Z`,
        );
        timeRow.diff = timeRow.endTime - timeRow.startTime;

        // Handle overflows past midnight
        if (timeRow.endTime < timeRow.startTime) {
          timeRow.diff += 24 * 60 * 60 * 1000;
        }

        let fractionalTime = dateToFraction(timeRow.diff);
        subtotalCell.innerText = twoPad(fractionalTime);
      }

      /**
       * Update the total cell in the table to reflect the current totals.
       **/
      function updateTotal() {
        let total = 0;
        timeRows.forEach((v, k) => {
          total += v.diff;
        });

        let fractional = dateToFraction(total);
        fractinal = twoPad(fractional);

        idGet("totalDiv").innerText = fractional;
      }

      /**
       * Reset the HTML timeRows table and the timeRows Object.
       **/
      function reset() {
        idGet("timeRows").replaceChildren([]);
        timeRows = new Map();
        addNewTimeRow();
        updateTotal();
      }

      /**
       * Delete a row from the timeRows HTML table and the timeRows Object.
       * @param {number} idx Index to identify the timeRow
       **/
      function deleteTimeRow(idx) {
        const tableRows = idGet("timeRows");
        const row = idGet(`row${idx}`);

        row.remove();
        timeRows.delete(idx);

        updateTotal();

        if (tableRows.children.length == 0) {
          reset();
        }
      }

      /**
       * Create table cell that contains an input[type="time"] element.
       * @param {('start'|'end')} name Name used for the input element's id
       * @param {number} idx Index used for the input element's id
       * @returns {HTMLTableCellElement}
       **/
      function createTimeInputCell(name, idx) {
        /** @type {HTMLTableCellElement} */
        const cell = document.createElement("td");
        /** @type {HTMLInputElement} */
        const input = document.createElement("input");

        cell.id = `${name}Cell${idx}`;
        input.id = `${name}Input${idx}`;
        input.type = "time";
        input.value = "09:00";
        input.classList.add("timeInput");

        input.oninput = function () {
          updateTimeDiff(name, idx);
          updateTotal();
        };

        cell.append(input);
        return cell;
      }

      /**
       * Create a table cell that contains the timeRow's time difference (subtotal)
       * @param {number} idx Index used for the cell's id
       * @returns {HTMLTableCellElement}
       **/
      function createSubtotalCell(idx) {
        /** @type {HTMLTableCellElement} */
        const subtotalCell = document.createElement("td");
        subtotalCell.id = `subtotalCell${idx}`;
        subtotalCell.innerText = defaultSubtotal;
        return subtotalCell;
      }

      /**
       * Create a table cell that contains a button to delete the timeRow
       * @param {number} idx Index used for the cell's id
       * @returns {HTMLTableCellElement}
       **/
      function createDeleteCell(idx) {
        /** @type {HTMLTableCellElement} */
        const cell = document.createElement("td");
        /** @type {HTMLButtonElement} */
        const button = document.createElement("button");

        cell.id = `deleteCell${idx}`;
        button.id = `deleteButton${idx}`;
        button.innerText = defaultSubtotal;
        button.innerText = "🗑 ";
        button.setAttribute("tabindex", "-1");
        button.addEventListener("click", (e) => {
          deleteTimeRow(idx);
        });

        cell.append(button);
        return cell;
      }

      /**
       * Add a new row to the `timeRows` table.
       **/
      function addNewTimeRow() {
        const idx = timeRows.size + 1;
        const tableRow = document.createElement("tr");

        const deleteCell = createDeleteCell(idx);
        const startCell = createTimeInputCell("start", idx);
        const endCell = createTimeInputCell("end", idx);
        const subtotalCell = createSubtotalCell(idx);

        tableRow.id = `row${idx}`;
        tableRow.append(deleteCell, startCell, endCell, subtotalCell);

        idGet("timeRows").append(tableRow);

        timeRows.set(idx, createTimeRow());
      }

      // %% Vim-like bindings %%
      class Vim {
        /**
         * Create object for adding Vim like keybinds for the page
         * @class
         */
        constructor() {
          this.keys = {
            newRow: "o",
            delete: "d",
          };
        }

        /**
         * Set keybinds
         */
        keymapSet() {
          this.newRow();
          this.deleteRow();
          this.clear();
          this.adjustTime();
          this.navigate();
        }

        /**
         * Create a new timeRow
         * @param key? Optional `newRow` override
         */
        newRow(key) {
          key = key ? key : this.keys.newRow;
          document.addEventListener("keydown", (e) => {
            if (e.key == key) {
              addNewTimeRow();
            }
          });
        }

        /**
         * Delete a time row
         * @param key? Optional `newRow` override
         */
        deleteRow(key) {
          key = key ? key : this.keys.delete;
          document.addEventListener("keydown", (e) => {
            if (e.key != key) {
              return;
            }
            const currEl = document.activeElement.parentNode.parentNode;
            try {
              const idx = currEl.id.match(/row(\d+)/)[1];
              const row = idGet(`row${idx}`);
              if (row !== undefined) {
                deleteTimeRow(idx);
                focusPrevInput(idx);
              }
            } catch (err) {
              console.log(err);
            }
          });
        }

        /**
         * Clear the focused input field with c
         */
        clear() {
          document.addEventListener("keydown", (e) => {
            if (e.key == "c") {
              const currNode = document.activeElement;
              currNode.value = "";
              currNode.blur();
              currNode.focus();
            }
          });
        }

        /**
         * Adjust time with jk  (minutes) hl (hours) or x (AM/PM toggle)
         */
        adjustTime() {
          document.addEventListener("keydown", (e) => {
            if (!e.altKey && "hjklx".includes(e.key)) {
              let currNode = document.activeElement;
              if (!currNode || !currNode.classList.contains("timeInput")) {
                return;
              }

              switch (e.key) {
                case "h":
                  currNode.stepDown(60);
                  break;
                case "j":
                  currNode.stepDown(1);
                  break;
                case "k":
                  currNode.stepUp(1);
                  break;
                case "l":
                  currNode.stepUp(60);
                  break;
                case "x":
                  const hh = currNode.value.match(/(\d+)/)[1];
                  let step = Number(hh) < 12 ? 720 : -720;
                  currNode.stepUp(step);
                  break;
              }

              const event = new Event("input");
              currNode.dispatchEvent(event);
            }
          });
        }

        /**
         * Navigate with JK (next/prev row), HL (next/prev input) or gG (first/last start input)
         */
        navigate() {
          // Navigation
          document.addEventListener("keydown", (e) => {
            if ("HJKLgG".includes(e.key)) {
              const keys = Array.from(timeRows.entries());
              const startType = "startInput";
              const endType = "endInput";

              let currNode = document.activeElement;

              if (!currNode || !currNode.classList.contains("timeInput")) {
                // TODO:
                findValidNode().focus();
                return;
              }
              const matches = currNode.id.match(/(\w+)(\d+)/);
              let type = matches[1];
              let rowIdx = Number(matches[2]);

              const currRow = idGet(`row${rowIdx}`);
              let siblingRow;
              if (e.key == "K") {
                siblingRow = currRow.previousSibling;
              } else if (e.key == "J") {
                siblingRow = currRow.nextSibling;
              }
              if (siblingRow) {
                rowIdx = siblingRow.id.match(/row(\d+)/)[1];
              }

              switch (e.key) {
                case "H":
                  type = startType;
                  break;
                case "J":
                  break;
                case "K":
                  break;
                case "L":
                  type = endType;
                  break;
                case "g":
                  rowIdx = keys.at(0).at(0);
                  type = startType;
                  break;
                case "G":
                  rowIdx = keys.at(-1).at(0);
                  type = startType;
                  break;
              }

              idGet(`${type}${rowIdx}`).focus();
            }
          });
        }
      }

      // %% On Load %%
      document.title = title;

      function onLoad() {
        const vim = new Vim();
        vim.keymapSet();

        idGet("calcCaption").innerText = title;

        uncheckInputElements();

        addNewTimeRow();

        // Focus first row on initial page load
        idGet("startInput1").focus();
      }

      document.body.onload = onLoad;
  </script>
  <div class="content">
    <!-- % HTML Content % -->
    <div class="firstCol">
      <div class="options">
        <div class="optionsHeader">
          Options
        </div>
        <div class="optionsContent">
          <div class="optionsCheckbox">
            <input type="checkbox" id="breaksCheck" name="breaksCheck" value="breaksCheck"> <label for="breaksCheck">Adjust by <em class="breaksVar">x</em> for every <em class="breaksVar">y</em> hours</label><br>
          </div>
          <div class="varInputsContainer">
            <div class="varInputsRow">
              where <em class="breaksVar">x</em> = <input type="number" value="-0.5" class="varInput" id="varX">
            </div>
            <div class="varInputsRow">
              and <em class="breaksVar">y</em> = <input type="number" value="6" class="varInput" id="varY">
            </div>
          </div>
        </div>
      </div>
      <div class="usage">
        <div class="usageHeader">
          Usage
        </div>
        <ul class="usageContent">
          <li>Type e.g. "1345" to enter 01:45 PM etc.</li>
          <li>New rows are automatically added as needed</li>
          <p>Keymap:</p>
          <li><span class="key">Tab</span> or <span class="key">"Shift+Tab"</span> move the focus left or right</li>
          <li><span class="key">y</span> to yank (copy) the total to the system clipboard</li>
          <li><span class="key">Y</span> to copy all complete rows as a TSV table to the system clipboard</li>
          <li><span class="key">c</span> to clear the current input field</li>
          <li><span class="key">d</span> to delete the current row</li>
          <li><span class="key">o</span> to create a new row</li>
          <li><span class="key">J</span> or <span class="key">K</span> to move down or up rows</li>
          <li><span class="key">H</span> or <span class="key">L</span> to move left or right in a row</li>
          <li><span class="key">g</span> or <span class="key">G</span> to focus the first or last row</li>
          <li><span class="key">j</span> or <span class="key">k</span> to increase/decrease minutes</li>
          <li><span class="key">h</span> or <span class="key">l</span> to increase/decrease hours</li>
          <li><span class="key">x</span> to toggle AM/PM</li>
          <li><span class="key">A</span> to toggle adjustment calculations</li>
        </ul>
      </div>
    </div>
    <div class="secondCol">
      <div class="calculator">
        <table>
          <caption id="calcCaption"></caption>
          <thead>
            <tr>
              <th></th>
              <th>Start</th>
              <th>End</th>
              <th>Subtotal</th>
            </tr>
          </thead>
          <tbody id="timeRows"></tbody>
          <tfoot>
            <tr>
              <th id="resetDiv"><button class="resetButton" tabindex="-1">↺</button></th>
              <th></th>
              <th>Total:</th>
              <th id="totalDiv"></th>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>
</body>
</html>
